<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الوسيط للشحن – لوحة التحكم الاحترافية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --bg-color: #f1f5f9;
            --text-color: #1e293b;
            --card-bg: white;
            --header-bg: rgba(255, 255, 255, 0.9);
            --input-bg: #f8fafc;
            --border-color: #e2e8f0;
            --table-header-bg: #f8fafc;
            --footer-bg: var(--dark);
            --footer-text: white;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --card-bg: #1e293b;
            --header-bg: rgba(30, 41, 59, 0.9);
            --input-bg: #334155;
            --border-color: #475569;
            --table-header-bg: #1e293b;
            --footer-bg: #020617;
            --footer-text: #cbd5e1;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; min-height: 100vh; display: flex; flex-direction: column; }

        .theme-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 1000; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: 0.3s; }
        .theme-toggle:hover { transform: scale(1.1); }

        header { background: var(--header-bg); backdrop-filter: blur(12px); padding: 15px 5%; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand img { height: 45px; width: 45px; border-radius: 12px; object-fit: cover; border: 2px solid var(--primary); }
        .brand h1 { font-size: 1.2rem; font-weight: 800; }

        nav { display: flex; gap: 8px; flex-wrap: wrap; }
        nav button { background: transparent; border: none; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 600; color: #64748b; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        nav button.active { background: var(--primary); color: white; }

        main { padding: 30px 5%; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1; }
        .page { display: none; animation: slideUp 0.4s ease-out; }
        .page.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 28px; border-radius: 24px; box-shadow: var(--card-shadow); margin-bottom: 30px; border: 1px solid var(--border-color); }
        .card h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; color: #64748b; }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; font-family: inherit; background: var(--input-bg); color: var(--text-color); outline: none; }
        input:focus { border-color: var(--primary); }

        .btn-save { margin-top: 20px; width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--secondary); color: white; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-save:hover { filter: brightness(1.1); transform: translateY(-2px); }

        .table-container { background: var(--card-bg); border-radius: 16px; overflow-x: auto; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--table-header-bg); padding: 16px; text-align: center; border-bottom: 2px solid var(--border-color); color: #64748b; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); text-align: center; }

        tbody tr { cursor: pointer; transition: 0.2s; }
        tbody tr:hover { background: rgba(37, 99, 235, 0.05); }

        .type-badge { padding: 5px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; }
        .export-bg { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .import-bg { background: rgba(37, 99, 235, 0.1); color: #2563eb; }

        .delete-btn { background: #fee2e2; color: var(--danger); border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; }
        .delete-btn:hover { background: var(--danger); color: white; }

        .modal { display: none; position: fixed; z-index: 3000; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 24px; padding: 30px; position: relative; box-shadow: var(--card-shadow); animation: slideUp 0.3s ease-out; }
        .details-list { list-style: none; margin-top: 20px; text-align: right; }
        .details-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .details-list li span:first-child { font-weight: bold; color: var(--primary); }
        .close-modal { position: absolute; top: 15px; left: 15px; cursor: pointer; font-size: 1.5rem; color: var(--danger); }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 25px; }
        .stat-item { background: var(--card-bg); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid var(--border-color); }
        .stat-item.net { background: var(--dark); color: white; }

        footer { background: var(--footer-bg); color: var(--footer-text); padding: 40px 5%; text-align: center; margin-top: 40px; }
        .social-links a { color: var(--footer-text); font-size: 1.5rem; margin: 0 10px; }

        .wa-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .wa-box { background: var(--card-bg); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; }
        .wa-btn { display: block; background: #25D366; color: white; padding: 15px; border-radius: 12px; margin: 10px 0; text-decoration: none; font-weight: bold; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; }
            nav { width: 100%; overflow-x: auto; padding-bottom: 5px; justify-content: center; }
        }
    /* استايل صفحة تسجيل الدخول */
#login-screen {
    position: fixed;
    inset: 0;
    background: var(--bg-color);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.login-card {
    background: var(--card-bg);
    padding: 40px;
    border-radius: 24px;
    box-shadow: var(--card-shadow);
    width: 100%;
    max-width: 400px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.login-card img {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    margin-bottom: 15px;
    border: 3px solid var(--primary);
}

.login-card h2 { margin-bottom: 5px; color: var(--primary); }
.login-card p { margin-bottom: 25px; color: #64748b; font-size: 0.9rem; }

.login-group { text-align: right; margin-bottom: 15px; }
.login-group label { display: block; margin-bottom: 5px; font-weight: bold; }

.btn-login {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.3s;
}

.btn-login:hover { background: var(--primary-hover); transform: translateY(-2px); }
    /* إخفاء الفوتر أثناء صفحة تسجيل الدخول */
body.login-active footer {
    display: none;
}

/* منع الاسكرول وقت تسجيل الدخول */
body.login-active {
    overflow: hidden;
}
    .login-success {
    animation: zoomFade 0.6s ease forwards;
}

@keyframes zoomFade {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.1); }
}
.shake {
    animation: shake 0.4s;
}

@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}
    </style>
</head>
<body>

    <div id="login-screen">
    <div class="login-card">
        <img src="logo.png" alt="الوسيط" onerror="this.src='https://ui-avatars.com/api/?name=W&background=2563eb&color=fff'">
        <h2>شركة الوسيط</h2>
        <p>الوسيط.. الحل الوسيط</p>
        
        <div class="login-group">
            <label>اسم المستخدم</label>
            <input type="text" id="username" placeholder="أدخل اسم المستخدم">
        </div>
        
        <div class="login-group">
            <label>كلمة المرور</label>
            <input type="password" id="password" placeholder="••••••••">
        </div>
        
        <button class="btn-login" onclick="checkLogin()">دخول لوحة التحكم</button>
        <p id="login-error" style="color: var(--danger); margin-top: 15px; display: none;">بيانات الدخول غير صحيحة!</p>
    </div>
</div>

    
    <button class="theme-toggle" id="themeToggle" title="تبديل الوضع">
        <i class="fas fa-moon"></i>
    </button>

    <header>
        <div class="brand">
            <img src="logo.png" alt="الوسيط" onerror="this.src='https://ui-avatars.com/api/?name=W&background=2563eb&color=fff'">
            <h1>الوسيط للشحن</h1>
        </div>
        <nav>
            <button onclick="showPage('main-page')" id="btn-main" class="active"><i class="fas fa-th-large"></i> لوحة التحكم</button>
            <button onclick="showPage('track-page')" id="btn-track"><i class="fas fa-search-location"></i> الاستعلام</button>
            <button onclick="showPage('elwaset-page')" id="btn-elwaset"><i class="fas fa-truck-fast"></i> خدماتنا</button>
            <button onclick="showPage('about-page')" id="btn-about"><i class="fas fa-info-circle"></i> عن الشركة</button>
        </nav>
    </header>

    <main>
        <section id="main-page" class="page active">
            <div class="card">
                <h3><i class="fas fa-file-invoice" style="color: var(--primary);"></i> تسجيل شحنة جديدة</h3>
                <div class="grid-form">
                    <div class="form-group"><label>رقم الشحنة</label><input id="orderId" type="text" placeholder="SH-1001"></div>
                    <div class="form-group"><label>اسم العميل</label><input id="customer" type="text" placeholder="الاسم ثلاثي"></div>
                    <div class="form-group"><label>الشركة</label><input id="category" type="text" placeholder="اسم المتجر"></div>
                    <div class="form-group">
                        <label>الوجهة</label>
                        <select id="governorate">
                            <option value="">-- اختر المحافظة --</option>
                            <option>الفيوم</option><option>بني سويف</option><option>المنيا</option>
                            <option>أسيوط</option><option>سوهاج</option><option>قنا</option>
                            <option>الأقصر</option><option>أسوان</option><option>الغردقة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>نوع العملية</label>
                        <select id="type">
                            <option value="صادرات">صادرات (توصيل)</option>
                            <option value="واردات">واردات (مرتجع)</option>
                        </select>
                    </div>
                    <div class="form-group"><label>المبلغ</label><input id="price" type="number" placeholder="0.00"></div>
                </div>
                <button onclick="addOrder()" id="saveBtn" class="btn-save"><i class="fas fa-check-circle"></i> تأكيد وحفظ الشحنة</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                    <h3><i class="fas fa-boxes-stacked" style="color: var(--primary);"></i> السجل التاريخي</h3>
                    <div style="position: relative; width: 300px;">
                        <i class="fas fa-search" style="position: absolute; right: 15px; top: 15px; color: #94a3b8;"></i>
                        <input id="search" placeholder="بحث باسم العميل أو الكود..." onkeyup="filterOrders()" style="padding-right: 40px;">
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>العميل</th>
                                <th>الحالة</th>
                                <th>المحافظة</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div class="stats">
                    <div class="stat-item"><h4>إجمالي الصادرات</h4><p id="totalExports">0 ج.م</p></div>
                    <div class="stat-item"><h4>إجمالي الواردات</h4><p id="totalImports">0 ج.م</p></div>
                    <div class="stat-item net"><h4>صافي التحصيل</h4><p id="netProfit">0 ج.م</p></div>
                </div>
            </div>
        </section>

        <section id="track-page" class="page">
            <div class="card" style="max-width: 700px; margin: 0 auto; text-align: center;">
                <h2 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-magnifying-glass"></i> تتبع وتعديل حالة الشحنة</h2>
                <p style="color: #64748b; margin-bottom: 25px;">ابحث عن الكود لتعديل حالة التسليم أو الاستلام فوراً.</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                    <input id="trackInput" type="text" placeholder="مثال: SH-1001" style="text-align: center; font-size: 1.1rem; border-color: var(--primary);">
                    <button onclick="trackOrder()" class="btn-save" style="margin-top: 0; width: 120px;">بحث</button>
                </div>

                <div id="trackResult" style="display: none;">
                    <div style="background: var(--input-bg); border: 2px solid var(--primary); padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: right;">
                        <label style="display: block; font-weight: 800; margin-bottom: 10px; color: var(--primary);">تغيير حالة الشحنة:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="updateStatusSelect" style="flex: 1;">
                                <option value="قيد المعالجة">قيد المعالجة</option>
                                <option value="تم شحنها">تم شحنها</option>
                                <option value="تم التسليم">تم التسليم للعميل</option>
                                <option value="تم الاستلام">تم الاستلام (مرتجع)</option>
                                <option value="مؤجل">مؤجل</option>
                                <option value="ملغي">ملغي</option>
                            </select>
                            <button id="updateStatusBtn" class="btn-save" style="margin: 0; width: 150px; background: var(--primary);">حفظ التحديث</button>
                        </div>
                    </div>

                    <div id="statusBadge" style="padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; font-size: 1.1rem;"></div>
                    
                    <div id="trackInfoContainer" class="details-list" style="border: 1px solid var(--border-color); padding: 20px; border-radius: 16px; background: var(--input-bg);"></div>
                </div>

                <div id="noTrackResult" style="display: none; padding: 30px; color: var(--danger);">
                    <i class="fas fa-times-circle" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>عذراً، رقم الشحنة غير موجود بالنظام.</p>
                </div>
            </div>
        </section>

        <section id="elwaset-page" class="page">
            <div class="card" style="text-align:center;">
                <h2 style="color:var(--primary)">الوسيط للشحن … السرعة التي تريحك</h2>
                <div class="features" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div class="feature" style="background: var(--input-bg); padding: 25px; border-radius: 16px;"><i class="fas fa-bolt" style="font-size: 2rem; color: #fbbf24;"></i><h3>توصيل سريع</h3><p>خلال 24-48 ساعة عمل</p></div>
                    <div class="feature" style="background: var(--input-bg); padding: 25px; border-radius: 16px;"><i class="fas fa-shield-halved" style="font-size: 2rem; color: var(--secondary);"></i><h3>أمان تام</h3><p>تأمين شامل على الطرود</p></div>
                    <div class="feature" onclick="openWhatsAppPopup()" style="background: var(--input-bg); padding: 25px; border-radius: 16px; cursor: pointer;"><i class="fas fa-headset" style="font-size: 2rem; color: var(--primary);"></i><h3>دعم فني</h3><p>متواجدون لخدمتكم دائماً</p></div>
                </div>
            </div>
        </section>

        <section id="about-page" class="page">
            <div class="card" style="text-align: center;">
                <img src="2.png" alt="الوسيط" style="max-width: 100%; border-radius: 20px;" onerror="this.src='https://via.placeholder.com/800x400?text=Al-Waset+Shipping'">
                <p style="margin-top:20px; font-size:1.1rem;">نحن شركة الوسيط، رواد الشحن في منطقة الصعيد والبحر الأحمر، نسعى دائماً لتقديم أفضل تجربة شحن لعملائنا.</p>
            </div>
        </section>
    </main>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 style="text-align: center; color: var(--primary);"><i class="fas fa-info-circle"></i> تفاصيل الشحنة</h3>
            <ul class="details-list" id="detailsContent"></ul>
            <button class="btn-save" onclick="closeModal()" style="margin-top: 20px; background: var(--dark);">إغلاق</button>
        </div>
    </div>

    <div class="wa-popup" id="waPopup">
        <div class="wa-box">
            <h3>تواصل معنا مباشرة</h3>
            <a class="wa-btn" href="https://wa.me/201028281203" target="_blank">خدمة العملاء 1</a>
            <a class="wa-btn" href="https://wa.me/201005558289" target="_blank">خدمة العملاء 2</a>
            <a class="wa-btn" href="https://wa.me/201004739659" target="_blank">خدمة العملاء 3</a>
            <button onclick="closeWhatsAppPopup()" style="background:none; border:none; color:#64748b; cursor:pointer; margin-top:10px;">إغلاق</button>
        </div>
    </div>

    <footer>
        <div class="social-links">
            <a href="https://www.facebook.com/share/1B2gBAgmxS/"><i class="fab fa-facebook"></i></a>
            <a href="https://wa.me/201028281203"><i class="fab fa-whatsapp"></i></a>
        </div>
        <p style="margin-top:15px;">© 2025 الوسيط للشحن - جميع الحقوق محفوظة</p>
    </footer>

    <script>
        const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        
        function updateThemeIcon() {
            const isDark = html.getAttribute('data-theme') === 'dark';
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        themeToggle.addEventListener('click', () => {
            const current = html.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            updateThemeIcon();
        });

        if (localStorage.getItem('theme') === 'dark') {
            html.setAttribute('data-theme', 'dark');
            updateThemeIcon();
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btnId = 'btn-' + id.split('-')[0];
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            window.scrollTo(0,0);
        }

        function openWhatsAppPopup() { document.getElementById("waPopup").style.display = "flex"; }
        function closeWhatsAppPopup() { document.getElementById("waPopup").style.display = "none"; }
        window.closeModal = function() { document.getElementById("detailsModal").style.display = "none"; };
    function loginSuccessAnimation() {
    const screen = document.getElementById('login-screen');
    screen.classList.add('login-success');

    setTimeout(() => {
        screen.style.display = 'none';
        document.body.classList.remove('login-active');
    }, 600);
}
    function shakeLogin() {
    const card = document.querySelector('.login-card');
    card.classList.remove('shake');
    void card.offsetWidth;
    card.classList.add('shake');
}
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDndL_0CFyoY8HCTQgiad502NkxrjJazl4",
            authDomain: "elwaset-99cfa.firebaseapp.com",
            projectId: "elwaset-99cfa",
            storageBucket: "elwaset-99cfa.firebasestorage.app",
            messagingSenderId: "1074967858040",
            appId: "1:1074967858040:web:23124e26636ccc8f95168d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let allOrders = [];
        let currentEditingUid = null;

        window.addOrder = async function () {
            const idInput = document.getElementById('orderId');
            const customerInput = document.getElementById('customer');
            const priceInput = document.getElementById('price');
            const saveBtn = document.getElementById('saveBtn');

            if (!idInput.value || !customerInput.value) {
                alert("برجاء ملء البيانات الأساسية");
                return;
            }

            const data = {
                id: idInput.value,
                customer: customerInput.value,
                category: document.getElementById('category').value,
                governorate: document.getElementById('governorate').value,
                type: document.getElementById('type').value,
                status: "قيد المعالجة", // حالة افتراضية
                price: Number(priceInput.value) || 0,
                createdAt: serverTimestamp()
            };

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
                await addDoc(collection(db, "orders"), data);
                idInput.value = ''; customerInput.value = ''; priceInput.value = '';
                document.getElementById('category').value = '';
            } catch (e) {
                alert("خطأ في الاتصال بالقاعدة");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد وحفظ الشحنة';
            }
        };

        window.deleteOrder = async function (docId) {
            if (confirm("هل تريد حذف هذه الشحنة نهائياً؟")) {
                await deleteDoc(doc(db, "orders", docId));
            }
        };

        window.showDetails = function(index) {
            const order = allOrders[index];
            const dateObj = order.createdAt ? order.createdAt.toDate() : new Date();
            const dateStr = dateObj.toLocaleDateString('ar-EG');
            const content = `
                <li><span>كود الشحنة:</span> <span>${order.id}</span></li>
                <li><span>الحالة الحالية:</span> <span style="color:var(--secondary)">${order.status || 'قيد المعالجة'}</span></li>
                <li><span>اسم العميل:</span> <span>${order.customer}</span></li>
                <li><span>الشركة/المتجر:</span> <span>${order.category || 'غير محدد'}</span></li>
                <li><span>المحافظة:</span> <span>${order.governorate}</span></li>
                <li><span>نوع العملية:</span> <span>${order.type}</span></li>
                <li><span>المبلغ:</span> <span>${order.price.toLocaleString()} ج.م</span></li>
                <li><span>التاريخ:</span> <span>${dateStr}</span></li>
            `;
            document.getElementById("detailsContent").innerHTML = content;
            document.getElementById("detailsModal").style.display = "flex";
        };

        // دالة الاستعلام مع زر تحديث الحالة
        window.trackOrder = function() {
            const input = document.getElementById('trackInput').value.trim().toLowerCase();
            const resultDiv = document.getElementById('trackResult');
            const noResultDiv = document.getElementById('noTrackResult');
            const infoContainer = document.getElementById('trackInfoContainer');
            const statusBadge = document.getElementById('statusBadge');
            const statusSelect = document.getElementById('updateStatusSelect');

            if(!input) {
                alert("يرجى إدخال كود الشحنة");
                return;
            }

            const order = allOrders.find(o => o.id.toLowerCase() === input);

            if(order) {
                currentEditingUid = order.uid; // حفظ الـ UID للتحديث
                noResultDiv.style.display = "none";
                resultDiv.style.display = "block";
                
                statusBadge.innerHTML = `<i class="fas fa-info-circle"></i> الحالة المسجلة: ${order.status || 'قيد المعالجة'}`;
                statusBadge.style = "background: rgba(37, 99, 235, 0.1); color: #2563eb; border: 1px solid #2563eb;";
                statusSelect.value = order.status || "قيد المعالجة";

                const dateObj = order.createdAt ? order.createdAt.toDate() : new Date();
                const dateStr = dateObj.toLocaleDateString('ar-EG');

                infoContainer.innerHTML = `
                    <ul class="details-list" style="margin-top:0;">
                        <li><span>كود التتبع:</span> <span>${order.id}</span></li>
                        <li><span>اسم العميل:</span> <span>${order.customer}</span></li>
                        <li><span>الوجهة:</span> <span>${order.governorate}</span></li>
                        <li><span>المبلغ:</span> <span>${order.price.toLocaleString()} ج.م</span></li>
                        <li><span>تاريخ التسجيل:</span> <span>${dateStr}</span></li>
                    </ul>
                `;
            } else {
                resultDiv.style.display = "none";
                noResultDiv.style.display = "block";
            }
        };

        // دالة حفظ تحديث الحالة في فايربيز
        document.getElementById('updateStatusBtn').onclick = async function() {
            if(!currentEditingUid) return;
            const newStatus = document.getElementById('updateStatusSelect').value;
            const btn = this;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> جاري الحفظ...';
                const docRef = doc(db, "orders", currentEditingUid);
                await updateDoc(docRef, { status: newStatus });
                alert("تم تحديث الحالة بنجاح!");
                trackOrder(); // إعادة تحميل بيانات الاستعلام
            } catch (e) {
                alert("حدث خطأ أثناء التحديث");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'حفظ التحديث';
            }
        };

        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            allOrders = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            renderTable(allOrders);
        });

        window.renderTable = function (orders) {
            const tbody = document.getElementById("tableBody");
            let ex = 0, im = 0;
            tbody.innerHTML = "";
            orders.forEach((o, index) => {
                if (o.type === "صادرات") ex += o.price; else im += o.price;
                const tr = document.createElement("tr");
                tr.onclick = (e) => { if(!e.target.closest('.delete-btn')) showDetails(index); };
                tr.innerHTML = `
                    <td style="color:var(--primary); font-weight:bold">${o.id}</td>
                    <td>${o.customer}</td>
                    <td><span style="font-weight:bold; color:var(--primary)">${o.status || 'قيد المعالجة'}</span></td>
                    <td>${o.governorate}</td>
                    <td><span class="type-badge ${o.type==='صادرات'?'export-bg':'import-bg'}">${o.type}</span></td>
                    <td style="font-weight:700">${o.price.toLocaleString()} ج.م</td>
                    <td><button class="delete-btn" onclick="deleteOrder('${o.uid}')"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById("totalExports").innerText = ex.toLocaleString() + " ج.م";
            document.getElementById("totalImports").innerText = im.toLocaleString() + " ج.م";
            document.getElementById("netProfit").innerText = (ex - im).toLocaleString() + " ج.م";
        };

        window.filterOrders = function () {
            const term = document.getElementById("search").value.toLowerCase();
            const filtered = allOrders.filter(o => o.customer.toLowerCase().includes(term) || o.id.toLowerCase().includes(term));
            renderTable(filtered);
        };
    // أضف هذه الدوال داخل السكريبت موديول (داخل type="module")

window.checkLogin = function() {
    const userInput = document.getElementById('username');
    const passInput = document.getElementById('password');
    const errorMsg = document.getElementById('login-error');

    const user = userInput.value.trim();
    const pass = passInput.value.trim();

    // تنظيف الألوان
    userInput.style.borderColor = '';
    passInput.style.borderColor = '';
    errorMsg.style.display = 'none';

    if (!user || !pass) {
        errorMsg.innerText = "من فضلك أدخل اسم المستخدم وكلمة المرور";
        errorMsg.style.display = 'block';

        if (!user) userInput.style.borderColor = 'var(--danger)';
        if (!pass) passInput.style.borderColor = 'var(--danger)';
        return;
    }

    const correctUser = "elwaset";
    const correctPass = "30919900";

    if (user === correctUser && pass === correctPass) {
        localStorage.setItem('isLoggedIn', 'true');
        loginSuccessAnimation();
    } else {
        errorMsg.innerText = "بيانات الدخول غير صحيحة";
        errorMsg.style.display = 'block';

        userInput.style.borderColor = 'var(--danger)';
        passInput.style.borderColor = 'var(--danger)';
        shakeLogin();
    }
};

    </script>
</body>
</html>
